#!/usr/bin/env python
"""
SOTA Macro-Benchmark for Multi-shot Video Generation
=====================================================
Method ë¹„êµ:
1. Auto-regressive (LTX-Video ìˆœì • ìˆœì°¨ ìƒì„±)
2. QSFM (Ours, ì–‘ì ë™ì‹œ ìƒì„±)

ê° Methodì˜ ì¶”ë¡  ìŠ¤í¬ë¦½íŠ¸ë¥¼ subprocessë¡œ í˜¸ì¶œí•˜ê³ , 
ìƒì„±ëœ profiling_metrics.jsonì„ ì½ì–´ ì¢…í•© CSV(Table)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
"""

import subprocess
import time
import json
import pandas as pd
from pathlib import Path

# ==========================================
# âš™ï¸ ë²¤ì¹˜ë§ˆí¬ ì„¤ì •
# ==========================================
METHODS = {
    # "í‘œì— ì¶œë ¥ë  ì´ë¦„": "ì‹¤í–‰í•  íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ëª…ë ¹ì–´"
    "Auto-regressive": "python scripts/run_autoregressive_inference.py",
    # "FreeNoise": "python scripts/run_free_noise_inference.py",  # ì¤€ë¹„ë˜ë©´ ì£¼ì„ í•´ì œ
    "QSFM (Ours)": "python scripts/run_pipeline.py"
}

K_VALUES = [4, 8, 16, 32]  # í‰ê°€í•  ìƒ·(Cut)ì˜ ê°œìˆ˜
FRAMES_PER_SHOT = 24       # 1ìƒ·ë‹¹ í”„ë ˆì„ ìˆ˜ (LTX-Video ê¸°ë³¸ 24í”„ë ˆì„ ê°€ì •)
STEPS = 30                 # Diffusion íƒ€ì„ìŠ¤í…

METRICS_FILE = Path("outputs/profiling_metrics.json")
OUTPUT_CSV = Path("outputs/sota_detailed_comparison.csv")

def run_benchmark():
    print("ğŸš€ SOTA Macro-Benchmark ì‹œì‘...")
    results = []

    for method_name, base_cmd in METHODS.items():
        for k in K_VALUES:
            print("-" * 60)
            print(f"ğŸƒ ì‹¤í–‰ ì¤‘: [{method_name}] K={k} ìƒ·")
            
            # Kìƒ·ì— í•„ìš”í•œ ì´ í”„ë ˆì„ ê³„ì‚° (Auto-regressive ìŠ¤í¬ë¦½íŠ¸ ë“±ì—ì„œ íŒŒë¼ë¯¸í„°ë¡œ ë°›ë„ë¡ ì²˜ë¦¬)
            total_frames = k * FRAMES_PER_SHOT
            
            # ëª…ë ¹ì–´ ì¡°í•© (í”„ë¡¬í”„íŠ¸ëŠ” í…ŒìŠ¤íŠ¸ìš© ì§§ì€ ê²ƒ ì‚¬ìš©)
            cmd = f"{base_cmd} --num_frames {total_frames} --steps {STEPS}"
            
            # ì´ì „ ë©”íŠ¸ë¦­ìŠ¤ íŒŒì¼ì´ ë‚¨ì•„ìˆë‹¤ë©´ ì‚­ì œ (ì¶©ëŒ ë°©ì§€)
            if METRICS_FILE.exists():
                METRICS_FILE.unlink()

            try:
                # í•˜ìœ„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (stdout ì¶œë ¥ì€ í„°ë¯¸ë„ì— í‘œì‹œ)
                subprocess.run(cmd, shell=True, check=True)
                
                # ì‹¤í–‰ì´ ì„±ê³µì ìœ¼ë¡œ ëë‚˜ë©´ JSON íŒŒì¼ ì½ê¸°
                if METRICS_FILE.exists():
                    with open(METRICS_FILE, "r") as f:
                        metrics = json.load(f)
                        
                    # ê²°ê³¼ ëˆ„ì 
                    row = {"Method": method_name, "K_shots": k}
                    row.update(metrics)
                    results.append(row)
                    print(f"âœ… ì¸¡ì • ì™„ë£Œ: {method_name} (K={k}) -> Denoising/Shot: {metrics['Denoising_Time_Per_Shot(s)']:.2f}s")
                else:
                    print(f"âŒ ì˜¤ë¥˜: {METRICS_FILE} ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¶”ë¡  ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì— JSON ì €ì¥ ë¡œì§ì„ í™•ì¸í•˜ì„¸ìš”.")
                    
            except subprocess.CalledProcessError as e:
                print(f"ğŸš¨ ëŸ°íƒ€ì„ ì—ëŸ¬ ë°œìƒ: [{method_name}] K={k} ìƒ· ì‹¤í–‰ ì‹¤íŒ¨")
                print(e)
                # ì—ëŸ¬ê°€ ë‚˜ë„ í‘œì— OOM(Out of Memory) ë“±ìœ¼ë¡œ ê¸°ë¡í•˜ê¸° ìœ„í•´ ì¶”ê°€
                results.append({
                    "Method": method_name,
                    "K_shots": k,
                    "Total_Generation_Time(s)": "OOM / Error",
                    "Total_Diffusion_Time(s)": "OOM / Error",
                    "Total_Decoding_Time(s)": "OOM / Error",
                    "Generation_Time_Per_Shot(s)": "OOM / Error",
                    "Denoising_Time_Per_Shot(s)": "OOM / Error",
                    "Peak_VRAM(MB)": "OOM / Error"
                })

    # ==========================================
    # ğŸ’¾ ê²°ê³¼ CSV ì €ì¥ ë° í‘œ ì¶œë ¥
    # ==========================================
    print("\n" + "=" * 80)
    print("ğŸ“Š ìµœì¢… ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼ (Table)")
    print("=" * 80)
    
    df = pd.DataFrame(results)
    
    # ë³´ê¸° ì¢‹ê²Œ ì½˜ì†” ì¶œë ¥
    print(df.to_string(index=False))
    
    # CSV ì €ì¥
    OUTPUT_CSV.parent.mkdir(parents=True, exist_ok=True)
    df.to_csv(OUTPUT_CSV, index=False)
    print(f"\nâœ… íŒŒì¼ ì €ì¥ ì™„ë£Œ: {OUTPUT_CSV}")
    print("ğŸ’¡ ë…¼ë¬¸ ë¶„ì„ íŒ: 'Denoising_Time_Per_Shot(s)' ì—´ì„ í™•ì¸í•˜ì„¸ìš”. QSFMì€ ê°’ì´ O(1)ë¡œ ì‘ì•„ì ¸ì•¼ ì„±ê³µì…ë‹ˆë‹¤!")

if __name__ == "__main__":
    run_benchmark()